<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>改进SSL证书相关策略 | johnpoint's blog</title><meta name=keywords content="SSL,折腾,建站"><meta name=description content="自从使用了 docker 作为基础环境以后，我想着写一个能够服务进行统一集中管理的面板，一方面不想使用市面上使用比较广泛面板 因为我做到他们不行啊啊啊，一方面也算是一种练习吧"><meta name=author content="johnpoint"><link rel=canonical href=https://blog.lvcshu.com/2019/01/10/%E6%94%B9%E8%BF%9Bssl%E8%AF%81%E4%B9%A6%E7%9B%B8%E5%85%B3%E7%AD%96%E7%95%A5/><link crossorigin=anonymous href=/assets/css/stylesheet.635203c1629fde69896622bdc0aee4210e2fa2ca161e2cc0cf7ea8ccf604149e.css integrity="sha256-Y1IDwWKf3mmJZiK9wK7kIQ4vosoWHizAz36ozPYEFJ4=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://blog.lvcshu.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.lvcshu.com/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://blog.lvcshu.com/favicon.ico><link rel=apple-touch-icon href=https://blog.lvcshu.com/favicon.ico><link rel=mask-icon href=https://blog.lvcshu.com/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="改进SSL证书相关策略"><meta property="og:description" content="自从使用了 docker 作为基础环境以后，我想着写一个能够服务进行统一集中管理的面板，一方面不想使用市面上使用比较广泛面板 因为我做到他们不行啊啊啊，一方面也算是一种练习吧"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.lvcshu.com/2019/01/10/%E6%94%B9%E8%BF%9Bssl%E8%AF%81%E4%B9%A6%E7%9B%B8%E5%85%B3%E7%AD%96%E7%95%A5/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-01-10T11:11:00+00:00"><meta property="article:modified_time" content="2019-01-10T11:11:00+00:00"><meta property="og:site_name" content="johnpoint's blog"><meta name=twitter:card content="summary"><meta name=twitter:title content="改进SSL证书相关策略"><meta name=twitter:description content="自从使用了 docker 作为基础环境以后，我想着写一个能够服务进行统一集中管理的面板，一方面不想使用市面上使用比较广泛面板 因为我做到他们不行啊啊啊，一方面也算是一种练习吧"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.lvcshu.com/posts/"},{"@type":"ListItem","position":2,"name":"改进SSL证书相关策略","item":"https://blog.lvcshu.com/2019/01/10/%E6%94%B9%E8%BF%9Bssl%E8%AF%81%E4%B9%A6%E7%9B%B8%E5%85%B3%E7%AD%96%E7%95%A5/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"改进SSL证书相关策略","name":"改进SSL证书相关策略","description":"自从使用了 docker 作为基础环境以后，我想着写一个能够服务进行统一集中管理的面板，一方面不想使用市面上使用比较广泛面板 因为我做到他们不行啊啊啊，一方面也算是一种练习吧\n","keywords":["SSL","折腾","建站"],"articleBody":"自从使用了 docker 作为基础环境以后，我想着写一个能够服务进行统一集中管理的面板，一方面不想使用市面上使用比较广泛面板 因为我做到他们不行啊啊啊，一方面也算是一种练习吧\n简述 抬头看下网站证书，yes！已经更换成泛域名证书啦~ 简单的说下现在已经实现的 满是bug的 功能，证书分发，前文提过我是集中一个面板进行管理，面板中集成一个文件 getcerfile.php 可以直接访问（当然是有鉴权的啦，证书什么的不鉴权放公网会凉的），证书选用 Let’s 签发泛域名证书这样就不用考虑证书签发的时候解析到底解析到哪台服务器上去了 不用造多轮子了，ye\n证书检测 这一部分主要是受了 Axton 大佬的启发 详情看 这篇文章 ，加上本人比较弱，且目前暂时还不想用上数据库存数据，所以目前是用文件 + shell 进行证书检查工作 配合 php 输出为不那么难看的页面 并且嵌入在面板中。\n效果图：\nemmmmmmmmm上传时发现自建图床好像出了问题。。考虑自己写一个？ 先咕咕咕为敬\n代码如下：\n#!/bin/sh cat urlfile.list | while read line do touch \"data/$line\" touch \"data/$line.ca\" curl https://$line -v -s -o /dev/null 2\u003e\"data/$line.ca\" datee=$(date +'%F %H:%M') echo \"最后检查: \" $datee \u003e \"data/$line\" data=$(cat \"data/$line.ca\" | grep 'subject:') echo \"证书域名: \" ${data##* subject: } \u003e\u003e \"data/$line\" data=$(cat \"data/$line.ca\" | grep 'start date:') data=$(date -d \"${data##* start date: }\" +'%F %H:%M:%S') echo \"签发日期: \"${data} \u003e\u003e \"data/$line\" startdate=$data data=$(cat \"data/$line.ca\" | grep 'expire date: ') data=$(date -d \"${data##* expire date: }\" +'%F %H:%M:%S') echo \"失效日期: \" $data \u003e\u003e \"data/$line\" enddate=$data data=$(cat \"data/$line.ca\" | grep 'issuer: ') echo \"签发机构: \"${data##* issuer: } \u003e\u003e \"data/$line\" data=$(cat \"data/$line.ca\" | grep 'SSL certificate verify ok.') echo \"证书状态: \"${data##* } \u003e\u003e \"data/$line\" startdate=$(date -d \"${startdate}\" +%s) enddate=$(date -d \"${enddate}\" +%s) datee=$(date -d \"${datee}\" +%s) long=$(($enddate-$startdate)) datee=$(($datee-$startdate)) datee=$(($datee*100)) hundred=100 persent=$(($datee/$long)) echo \"","wordCount":"326","inLanguage":"en","datePublished":"2019-01-10T11:11:00Z","dateModified":"2019-01-10T11:11:00Z","author":{"@type":"Person","name":"johnpoint"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.lvcshu.com/2019/01/10/%E6%94%B9%E8%BF%9Bssl%E8%AF%81%E4%B9%A6%E7%9B%B8%E5%85%B3%E7%AD%96%E7%95%A5/"},"publisher":{"@type":"Organization","name":"johnpoint's blog","logo":{"@type":"ImageObject","url":"https://blog.lvcshu.com/favicon.ico"}}}</script></head><body class=dark id=top><header class=header><nav class=nav><div class=logo><a href=https://blog.lvcshu.com/ accesskey=h title="johnpoint's blog (Alt + H)">johnpoint's blog</a><div class=logo-switches></div></div><ul id=menu><li><a href=https://blog.lvcshu.com/posts/ title=归档><span>归档</span></a></li><li><a href=https://blog.lvcshu.com/friends/ title=友链><span>友链</span></a></li><li><a href=https://blog.lvcshu.com/about/ title=关于我><span>关于我</span></a></li><li><a href=https://blog.lvcshu.com/search/ title="搜索 (Alt + /)" accesskey=/><span>搜索</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>改进SSL证书相关策略</h1><div class=post-meta><span title='2019-01-10 11:11:00 +0000 UTC'>2019-01-10 11:11:00</span>&nbsp;·&nbsp;2 min&nbsp;·&nbsp;326 words&nbsp;·&nbsp;johnpoint</div></header><div class=post-content><p>自从使用了 docker 作为基础环境以后，我想着写一个能够服务进行统一集中管理的面板，一方面不想使用市面上使用比较广泛面板 <del>因为我做到他们不行啊啊啊</del>，一方面也算是一种练习吧</p><h1 id=简述>简述<a hidden class=anchor aria-hidden=true href=#简述>#</a></h1><p>抬头看下网站证书，yes！已经更换成泛域名证书啦~
简单的说下现在已经实现的 <del>满是bug的</del> 功能，证书分发，前文提过我是集中一个面板进行管理，面板中集成一个文件 <code>getcerfile.php</code> 可以直接访问（当然是有鉴权的啦，证书什么的不鉴权放公网会凉的），证书选用 Let’s 签发泛域名证书这样就不用考虑证书签发的时候解析到底解析到哪台服务器上去了 <del>不用造多轮子了，ye</del></p><h1 id=证书检测>证书检测<a hidden class=anchor aria-hidden=true href=#证书检测>#</a></h1><p>这一部分主要是受了 Axton 大佬的启发 详情看 <a href=https://flyhigher.top/develop/755.html>这篇文章</a> ，加上本人比较弱，且目前暂时还不想用上数据库存数据，所以目前是用文件 + shell 进行证书检查工作 配合 php 输出为不那么难看的页面 并且嵌入在面板中。</p><p>效果图：</p><p><img loading=lazy src=https://i.loli.net/2019/01/10/5c36bc4ecd015.png alt></p><p>emmmmmmmmm上传时发现自建图床好像出了问题。。考虑自己写一个？ <del>先咕咕咕为敬</del></p><p>代码如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/sh
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl>cat urlfile.list <span class=p>|</span> <span class=k>while</span> <span class=nb>read</span> line
</span></span><span class=line><span class=cl><span class=k>do</span>
</span></span><span class=line><span class=cl>  touch <span class=s2>&#34;data/</span><span class=nv>$line</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  touch <span class=s2>&#34;data/</span><span class=nv>$line</span><span class=s2>.ca&#34;</span>
</span></span><span class=line><span class=cl>  curl https://<span class=nv>$line</span> -v -s -o /dev/null 2&gt;<span class=s2>&#34;data/</span><span class=nv>$line</span><span class=s2>.ca&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nv>datee</span><span class=o>=</span><span class=k>$(</span>date +<span class=s1>&#39;%F %H:%M&#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>  <span class=nb>echo</span> <span class=s2>&#34;最后检查: &#34;</span> <span class=nv>$datee</span> &gt; <span class=s2>&#34;data/</span><span class=nv>$line</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nv>data</span><span class=o>=</span><span class=k>$(</span>cat <span class=s2>&#34;data/</span><span class=nv>$line</span><span class=s2>.ca&#34;</span> <span class=p>|</span> grep <span class=s1>&#39;subject:&#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>  <span class=nb>echo</span> <span class=s2>&#34;证书域名: &#34;</span> <span class=si>${</span><span class=nv>data</span><span class=p>##* subject: </span><span class=si>}</span> &gt;&gt; <span class=s2>&#34;data/</span><span class=nv>$line</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nv>data</span><span class=o>=</span><span class=k>$(</span>cat <span class=s2>&#34;data/</span><span class=nv>$line</span><span class=s2>.ca&#34;</span> <span class=p>|</span> grep <span class=s1>&#39;start date:&#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>  <span class=nv>data</span><span class=o>=</span><span class=k>$(</span>date -d <span class=s2>&#34;</span><span class=si>${</span><span class=nv>data</span><span class=p>##* start date: </span><span class=si>}</span><span class=s2>&#34;</span> +<span class=s1>&#39;%F %H:%M:%S&#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>  <span class=nb>echo</span> <span class=s2>&#34;签发日期: &#34;</span><span class=si>${</span><span class=nv>data</span><span class=si>}</span> &gt;&gt; <span class=s2>&#34;data/</span><span class=nv>$line</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nv>startdate</span><span class=o>=</span><span class=nv>$data</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nv>data</span><span class=o>=</span><span class=k>$(</span>cat <span class=s2>&#34;data/</span><span class=nv>$line</span><span class=s2>.ca&#34;</span> <span class=p>|</span> grep <span class=s1>&#39;expire date: &#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>  <span class=nv>data</span><span class=o>=</span><span class=k>$(</span>date -d <span class=s2>&#34;</span><span class=si>${</span><span class=nv>data</span><span class=p>##* expire date: </span><span class=si>}</span><span class=s2>&#34;</span> +<span class=s1>&#39;%F %H:%M:%S&#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>  <span class=nb>echo</span> <span class=s2>&#34;失效日期: &#34;</span> <span class=nv>$data</span> &gt;&gt; <span class=s2>&#34;data/</span><span class=nv>$line</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nv>enddate</span><span class=o>=</span><span class=nv>$data</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nv>data</span><span class=o>=</span><span class=k>$(</span>cat <span class=s2>&#34;data/</span><span class=nv>$line</span><span class=s2>.ca&#34;</span> <span class=p>|</span> grep <span class=s1>&#39;issuer: &#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>  <span class=nb>echo</span> <span class=s2>&#34;签发机构: &#34;</span><span class=si>${</span><span class=nv>data</span><span class=p>##* issuer: </span><span class=si>}</span> &gt;&gt; <span class=s2>&#34;data/</span><span class=nv>$line</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nv>data</span><span class=o>=</span><span class=k>$(</span>cat <span class=s2>&#34;data/</span><span class=nv>$line</span><span class=s2>.ca&#34;</span> <span class=p>|</span> grep <span class=s1>&#39;SSL certificate verify ok.&#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>  <span class=nb>echo</span> <span class=s2>&#34;证书状态: &#34;</span><span class=si>${</span><span class=nv>data</span><span class=p>##* </span><span class=si>}</span> &gt;&gt; <span class=s2>&#34;data/</span><span class=nv>$line</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nv>startdate</span><span class=o>=</span><span class=k>$(</span>date -d <span class=s2>&#34;</span><span class=si>${</span><span class=nv>startdate</span><span class=si>}</span><span class=s2>&#34;</span> +%s<span class=k>)</span>
</span></span><span class=line><span class=cl>  <span class=nv>enddate</span><span class=o>=</span><span class=k>$(</span>date -d <span class=s2>&#34;</span><span class=si>${</span><span class=nv>enddate</span><span class=si>}</span><span class=s2>&#34;</span> +%s<span class=k>)</span>
</span></span><span class=line><span class=cl>  <span class=nv>datee</span><span class=o>=</span><span class=k>$(</span>date -d <span class=s2>&#34;</span><span class=si>${</span><span class=nv>datee</span><span class=si>}</span><span class=s2>&#34;</span> +%s<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nv>long</span><span class=o>=</span><span class=k>$((</span><span class=nv>$enddate</span><span class=o>-</span><span class=nv>$startdate</span><span class=k>))</span>
</span></span><span class=line><span class=cl>  <span class=nv>datee</span><span class=o>=</span><span class=k>$((</span><span class=nv>$datee</span><span class=o>-</span><span class=nv>$startdate</span><span class=k>))</span>
</span></span><span class=line><span class=cl>  <span class=nv>datee</span><span class=o>=</span><span class=k>$((</span><span class=nv>$datee</span><span class=o>*</span><span class=m>100</span><span class=k>))</span>
</span></span><span class=line><span class=cl>  <span class=nv>hundred</span><span class=o>=</span><span class=m>100</span>
</span></span><span class=line><span class=cl>  <span class=nv>persent</span><span class=o>=</span><span class=k>$((</span><span class=nv>$datee</span><span class=o>/</span><span class=nv>$long</span><span class=k>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nb>echo</span> <span class=s2>&#34;&lt;div class=\&#34;mdui-progress\&#34;&gt;&lt;div class=\&#34;mdui-progress-determinate\&#34; style=\&#34;width: </span><span class=si>${</span><span class=nv>persent</span><span class=si>}</span><span class=s2>%;\&#34;&gt;&lt;/div&gt;&lt;/div&gt;&#34;</span> &gt;&gt; <span class=s2>&#34;data/</span><span class=nv>$line</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  rm <span class=s2>&#34;data/</span><span class=nv>$line</span><span class=s2>.ca&#34;</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span></code></pre></div><p>展示的代码如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&lt;?php
</span></span><span class=line><span class=cl>include_once &#39;config.php&#39;;
</span></span><span class=line><span class=cl>if ($_COOKIE[&#34;user&#34;] == md5($username.$userpasswd)) {
</span></span><span class=line><span class=cl>    echo &#39;&lt;div class=&#34;mdui-panel&#34; mdui-panel&gt;&#39;;
</span></span><span class=line><span class=cl>    function listDir($dir)
</span></span><span class=line><span class=cl>    {
</span></span><span class=line><span class=cl>        if (is_dir($dir)) {
</span></span><span class=line><span class=cl>            if ($dh = opendir($dir)) {
</span></span><span class=line><span class=cl>                while (($file = readdir($dh)) !== false) {
</span></span><span class=line><span class=cl>                    if ($file != &#34;.&#34; &amp;&amp; $file != &#34;..&#34;) {
</span></span><span class=line><span class=cl>                        echo &#39;&lt;div class=&#34;mdui-panel-item&#34;&gt;&#39;;
</span></span><span class=line><span class=cl>                        echo &#39;&lt;div class=&#34;mdui-panel-item-header&#34;&gt;&#39;.&#39;&lt;div class=&#34;mdui-panel-item-title&#34;&gt;&#39;.$file.&#39;&lt;/div&gt;&#39;.&#39;&lt;i class=&#34;mdui-panel-item-arrow mdui-icon material-icons&#34;&gt;keyboard_arrow_down&lt;/i&gt;&#39;.&#39;&lt;/div&gt;&#39;;
</span></span><span class=line><span class=cl>                        echo &#39;&lt;div class=&#34;mdui-panel-item-body&#34;&gt;&#39;;
</span></span><span class=line><span class=cl>                        $myfile = fopen(&#34;$dir/$file&#34;, &#34;r&#34;) or die(&#34;Unable to open file!&#34;);
</span></span><span class=line><span class=cl>                        while (!feof($myfile)) {
</span></span><span class=line><span class=cl>                            echo &#39;&lt;p&gt;&#39;.fgets($myfile) . &#39;&lt;/p&gt;&#39;;
</span></span><span class=line><span class=cl>                        }
</span></span><span class=line><span class=cl>                        echo &#39;&lt;/div&gt;&lt;/div&gt;&#39;;
</span></span><span class=line><span class=cl>                        fclose($myfile);
</span></span><span class=line><span class=cl>                    }
</span></span><span class=line><span class=cl>                }
</span></span><span class=line><span class=cl>                closedir($dh);
</span></span><span class=line><span class=cl>            }
</span></span><span class=line><span class=cl>        } else {
</span></span><span class=line><span class=cl>            echo $dir . &#39;&lt;br&gt;&#39;;
</span></span><span class=line><span class=cl>        }
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>    listDir(&#34;./data&#34;);
</span></span><span class=line><span class=cl>    echo &#39;&lt;/div&gt;&#39;;
</span></span><span class=line><span class=cl>} else {
</span></span><span class=line><span class=cl>    echo &#39;error&#39;;
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>?&gt;
</span></span></code></pre></div><h1 id=证书分发>证书分发<a hidden class=anchor aria-hidden=true href=#证书分发>#</a></h1><p>emmmm上面也看的出来我是用 user 和 passwd md5一下写进cookie进行验证的，需要验证的 域名直接存放在 <code>urlfile.list</code> 文件里面 (我实在是太菜了)</p><p>同理分发证书也利用 cookie 进行身份验证</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&lt;?php
</span></span><span class=line><span class=cl>include_once &#39;config.php&#39;;
</span></span><span class=line><span class=cl>if ($_COOKIE[&#34;user&#34;] == md5($username.$userpasswd)) {
</span></span><span class=line><span class=cl>    $myfile = fopen($_GET[&#39;file&#39;], &#34;r&#34;) or die(&#34;Unable to open file!&#34;);
</span></span><span class=line><span class=cl>    echo fread($myfile, filesize($_GET[&#39;file&#39;]));
</span></span><span class=line><span class=cl>    fclose($myfile);
</span></span><span class=line><span class=cl>} else {
</span></span><span class=line><span class=cl>    header(&#34;Location: /index.php&#34;);
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>?&gt;
</span></span></code></pre></div><p>然后直接读取证书文件进行直接输出，同时 nginx 那儿对文件目录进行权限控制，获取证书使用</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>curl https://****/getcerfile.php?file=ssl/lvcshu.com/lvcshu.com.key -H &#39;cookie: user=？？？&#39; &gt; lvcshu.com.key
</span></span></code></pre></div><p>获取，这样在需要部署证书服务器上定时执行脚本可以更新证书了，同时 泛域名证书 使用 acme.sh 进行自动续期 emmmmmmmm 差不多这样如各位大佬发现什么不妥地方记得及时联系我啊 QAQ
Telegram:<a href=https://t.me/johnpoint>@johnpoint</a></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.lvcshu.com/tags/ssl/>SSL</a></li><li><a href=https://blog.lvcshu.com/tags/%E6%8A%98%E8%85%BE/>折腾</a></li><li><a href=https://blog.lvcshu.com/tags/%E5%BB%BA%E7%AB%99/>建站</a></li></ul><script>var pageInfo=`{"RawContent":"\\n自从使用了 docker 作为基础环境以后，我想着写一个能够服务进行统一集中管理的面板，一方面不想使用市面上使用比较广泛面板 ~~因为我做到他们不行啊啊啊~~，一方面也算是一种练习吧\\u003c!--more--\\u003e\\n\\n# 简述\\n\\n抬头看下网站证书，yes！已经更换成泛域名证书啦~\\n简单的说下现在已经实现的 ~~满是bug的~~ 功能，证书分发，前文提过我是集中一个面板进行管理，面板中集成一个文件 \`getcerfile.php\` 可以直接访问（当然是有鉴权的啦，证书什么的不鉴权放公网会凉的），证书选用 Let’s 签发泛域名证书这样就不用考虑证书签发的时候解析到底解析到哪台服务器上去了 ~~不用造多轮子了，ye~~\\n\\n# 证书检测\\n\\n这一部分主要是受了  Axton 大佬的启发 详情看 [这篇文章](https://flyhigher.top/develop/755.html) ，加上本人比较弱，且目前暂时还不想用上数据库存数据，所以目前是用文件 + shell 进行证书检查工作 配合 php 输出为不那么难看的页面 并且嵌入在面板中。\\n\\n效果图：\\n\\n![](https://i.loli.net/2019/01/10/5c36bc4ecd015.png)\\n\\nemmmmmmmmm上传时发现自建图床好像出了问题。。考虑自己写一个？ ~~先咕咕咕为敬~~\\n\\n代码如下：\\n\`\`\`\\n#!/bin/sh\\n\\ncat urlfile.list | while read line\\ndo\\n  touch \\"data/$line\\"\\n  touch \\"data/$line.ca\\"\\n  curl https://$line -v -s -o /dev/null 2\\u003e\\"data/$line.ca\\"\\n  datee=$(date +'%F %H:%M')\\n  echo \\"最后检查: \\" $datee \\u003e \\"data/$line\\"\\n\\n  data=$(cat \\"data/$line.ca\\" | grep 'subject:')\\n  echo \\"证书域名: \\" \${data##* subject: } \\u003e\\u003e \\"data/$line\\"\\n\\n  data=$(cat \\"data/$line.ca\\" | grep 'start date:')\\n  data=$(date -d \\"\${data##* start date: }\\" +'%F %H:%M:%S')\\n  echo \\"签发日期: \\"\${data} \\u003e\\u003e \\"data/$line\\"\\n  startdate=$data\\n\\n  data=$(cat \\"data/$line.ca\\" | grep 'expire date: ')\\n  data=$(date -d \\"\${data##* expire date: }\\" +'%F %H:%M:%S')\\n  echo \\"失效日期: \\" $data \\u003e\\u003e \\"data/$line\\"\\n  enddate=$data\\n\\n  data=$(cat \\"data/$line.ca\\" | grep 'issuer: ')\\n  echo \\"签发机构: \\"\${data##* issuer: } \\u003e\\u003e \\"data/$line\\"\\n\\n  data=$(cat \\"data/$line.ca\\" | grep 'SSL certificate verify ok.')\\n  echo \\"证书状态: \\"\${data##* } \\u003e\\u003e \\"data/$line\\"\\n\\n  startdate=$(date -d \\"\${startdate}\\" +%s)\\n  enddate=$(date -d \\"\${enddate}\\" +%s)\\n  datee=$(date -d \\"\${datee}\\" +%s)\\n\\n  long=$(($enddate-$startdate))\\n  datee=$(($datee-$startdate))\\n  datee=$(($datee*100))\\n  hundred=100\\n  persent=$(($datee/$long))\\n\\n  echo \\"\\u003cdiv class=\\\\\\"mdui-progress\\\\\\"\\u003e\\u003cdiv class=\\\\\\"mdui-progress-determinate\\\\\\" style=\\\\\\"width: \${persent}%;\\\\\\"\\u003e\\u003c/div\\u003e\\u003c/div\\u003e\\" \\u003e\\u003e \\"data/$line\\"\\n\\n  rm \\"data/$line.ca\\"\\ndone\\n\`\`\`\\n展示的代码如下：\\n\`\`\`\\n\\u003c?php\\ninclude_once 'config.php';\\nif ($_COOKIE[\\"user\\"] == md5($username.$userpasswd)) {\\n    echo '\\u003cdiv class=\\"mdui-panel\\" mdui-panel\\u003e';\\n    function listDir($dir)\\n    {\\n        if (is_dir($dir)) {\\n            if ($dh = opendir($dir)) {\\n                while (($file = readdir($dh)) !== false) {\\n                    if ($file != \\".\\" \\u0026\\u0026 $file != \\"..\\") {\\n                        echo '\\u003cdiv class=\\"mdui-panel-item\\"\\u003e';\\n                        echo '\\u003cdiv class=\\"mdui-panel-item-header\\"\\u003e'.'\\u003cdiv class=\\"mdui-panel-item-title\\"\\u003e'.$file.'\\u003c/div\\u003e'.'\\u003ci class=\\"mdui-panel-item-arrow mdui-icon material-icons\\"\\u003ekeyboard_arrow_down\\u003c/i\\u003e'.'\\u003c/div\\u003e';\\n                        echo '\\u003cdiv class=\\"mdui-panel-item-body\\"\\u003e';\\n                        $myfile = fopen(\\"$dir/$file\\", \\"r\\") or die(\\"Unable to open file!\\");\\n                        while (!feof($myfile)) {\\n                            echo '\\u003cp\\u003e'.fgets($myfile) . '\\u003c/p\\u003e';\\n                        }\\n                        echo '\\u003c/div\\u003e\\u003c/div\\u003e';\\n                        fclose($myfile);\\n                    }\\n                }\\n                closedir($dh);\\n            }\\n        } else {\\n            echo $dir . '\\u003cbr\\u003e';\\n        }\\n    }\\n    listDir(\\"./data\\");\\n    echo '\\u003c/div\\u003e';\\n} else {\\n    echo 'error';\\n}\\n?\\u003e\\n\`\`\`\\n\\n# 证书分发\\n\\nemmmm上面也看的出来我是用 user 和 passwd md5一下写进cookie进行验证的，需要验证的 域名直接存放在 \`urlfile.list\` 文件里面 (我实在是太菜了)\\n\\n同理分发证书也利用 cookie 进行身份验证\\n\\n\`\`\`\\n\\u003c?php\\ninclude_once 'config.php';\\nif ($_COOKIE[\\"user\\"] == md5($username.$userpasswd)) {\\n    $myfile = fopen($_GET['file'], \\"r\\") or die(\\"Unable to open file!\\");\\n    echo fread($myfile, filesize($_GET['file']));\\n    fclose($myfile);\\n} else {\\n    header(\\"Location: /index.php\\");\\n}\\n?\\u003e\\n\`\`\`\\n然后直接读取证书文件进行直接输出，同时 nginx 那儿对文件目录进行权限控制，获取证书使用\\n\\n\`\`\`\\ncurl https://****/getcerfile.php?file=ssl/lvcshu.com/lvcshu.com.key -H 'cookie: user=？？？' \\u003e lvcshu.com.key\\n\`\`\`\\n\\n获取，这样在需要部署证书服务器上定时执行脚本可以更新证书了，同时 泛域名证书 使用 acme.sh 进行自动续期 emmmmmmmm 差不多这样如各位大佬发现什么不妥地方记得及时联系我啊 QAQ\\nTelegram:[@johnpoint](https://t.me/johnpoint)\\n","ResourceType":"page","MediaType":{"mainType":"application","subType":"octet-stream","delimiter":".","firstSuffix":{"suffix":"","fullSuffix":""},"type":"application/octet-stream","string":"application/octet-stream","suffixes":[""]},"Permalink":"https://blog.lvcshu.com/2019/01/10/%E6%94%B9%E8%BF%9Bssl%E8%AF%81%E4%B9%A6%E7%9B%B8%E5%85%B3%E7%AD%96%E7%95%A5/","RelPermalink":"/2019/01/10/%E6%94%B9%E8%BF%9Bssl%E8%AF%81%E4%B9%A6%E7%9B%B8%E5%85%B3%E7%AD%96%E7%95%A5/","Name":"改进SSL证书相关策略","Title":"改进SSL证书相关策略","Params":{"author":"johnpoint","date":"2019-01-10T11:11:00Z","draft":false,"iscjklanguage":false,"lastmod":"2019-01-10T11:11:00Z","pressone":"https://press.one/file/v?s=63fcb3a91f42c81f766fe6e07d665ae5ad4f399619a4c94707f3e4a31764264f4a36a9b74bf0f482a5c336892af861dd20eaca52b03543f2902b9429f076c1b701\\u0026h=8d731d8b814e9dfaa1047e090233116b13d9ecfdb92a04abc57e8975cfddc189\\u0026a=79a3a060a7faa9dfc9b8b4e0a59bf3ebac305f78\\u0026v=3\\u0026f=P1","publishdate":"2019-01-10T11:11:00Z","slug":"改进SSL证书相关策略","tags":["SSL","折腾","建站"],"title":"改进SSL证书相关策略","toc":true},"Data":{},"Date":"2019-01-10T11:11:00Z","Lastmod":"2019-01-10T11:11:00Z","PublishDate":"2019-01-10T11:11:00Z","ExpiryDate":"0001-01-01T00:00:00Z","Aliases":null,"BundleType":"","Description":"","Draft":false,"IsHome":false,"Keywords":null,"Kind":"page","Layout":"","LinkTitle":"改进SSL证书相关策略","IsNode":false,"IsPage":true,"Path":"posts/改进SSL证书相关策略.md","Pathc":"posts/改进SSL证书相关策略.md","Slug":"改进SSL证书相关策略","Lang":"en","IsSection":false,"Section":"posts","SectionsEntries":["posts"],"SectionsPath":"posts","Sitemap":{"ChangeFreq":"","Priority":-1,"Filename":"sitemap.xml"},"Type":"posts","Weight":0,"Language":{"Lang":"en","LanguageName":"","LanguageDirection":"","Title":"","Weight":0,"Disabled":false,"ContentDir":"","Cfg":{},"LocalCfg":{},"Provider":{}},"File":{"File":{}},"GitInfo":{"hash":"","abbreviatedHash":"","subject":"","authorName":"","authorEmail":"","authorDate":"0001-01-01T00:00:00Z","commitDate":"0001-01-01T00:00:00Z"},"CodeOwners":null,"OutputFormats":[{"Rel":"canonical","Format":{"mediaType":"text/html","name":"HTML","path":"","baseName":"index","rel":"canonical","protocol":"","isPlainText":false,"isHTML":true,"noUgly":false,"notAlternative":false,"permalinkable":true,"weight":10}}],"AlternativeOutputFormats":null,"Menus":null,"TranslationKey":"page/posts/改进SSL证书相关策略","IsTranslated":false,"AllTranslations":null,"Translations":null,"Store":{},"GetIdentity":{"Type":"content","Path":"posts/改进ssl证书相关策略.md"}}`</script><div><ul class=post-copyright><li class=post-copyright-author><a>本文作者: </a>johnpoint</li><li class=post-copyright-link><a>本文链接:</a>
<a href id=copyrightlink>https://blog.lvcshu.com/2019/01/10/%E6%94%B9%E8%BF%9Bssl%E8%AF%81%E4%B9%A6%E7%9B%B8%E5%85%B3%E7%AD%96%E7%95%A5/</a></li><li class=post-copyright-license><a>版权声明:</a>
本作品采用<a rel=license href=http://creativecommons.org/licenses/by-sa/4.0/>知识共享署名-相同方式共享 4.0 国际许可协议</a>进行许可。</li><svg xmlns="http://www.w3.org/2000/svg" class="copyright-img" viewBox="0 0 496 512"><path fill="#4a4a4a" d="m245.8 214.9-33.2 17.3c-9.4-19.6-25.2-20-27.4-20-22.2.0-33.3 14.6-33.3 43.9.0 23.5 9.2 43.8 33.3 43.8 14.4.0 24.6-7 30.5-21.3l30.6 15.5a73.2 73.2.0 01-65.1 39c-22.6.0-74-10.3-74-77 0-58.7 43-77 72.6-77 30.8-.1 52.7 11.9 66 35.8zm143 0-32.7 17.3c-9.5-19.8-25.7-20-27.9-20-22.1.0-33.2 14.6-33.2 43.9.0 23.5 9.2 43.8 33.2 43.8 14.5.0 24.7-7 30.5-21.3l31 15.5c-2 3.8-21.3 39-65 39-22.7.0-74-9.9-74-77 0-58.7 43-77 72.6-77C354 179 376 191 389 214.8zM247.7 8C104.7 8 0 123 0 256c0 138.4 113.6 248 247.6 248C377.5 504 496 403 496 256 496 118 389.4 8 247.6 8zm.8 450.8c-112.5.0-203.7-93-203.7-202.8.0-105.5 85.5-203.3 203.8-203.3A201.7 201.7.0 01451.3 256c0 121.7-99.7 202.9-202.9 202.9z"/></svg></ul></div><nav class=paginav><a class=prev href=https://blog.lvcshu.com/2019/01/14/%E7%9C%9F-%E5%A4%9A%E7%82%B9%E9%83%A8%E7%BD%B2%E5%8D%9A%E5%AE%A2/><span class=title>« Prev</span><br><span>真-多点部署博客</span></a>
<a class=next href=https://blog.lvcshu.com/2018/12/25/2018%E5%B9%B4%E5%BA%A6%E7%AE%80%E6%8A%A5/><span class=title>Next »</span><br><span>2018年度简报</span></a></nav><div id=disqus_thread></div><script>(function(){var e=document,t=e.createElement("script");t.src="https://johnpoints-blog-hexo.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></footer></article><style>.copyright-img{position:absolute;width:128px;height:128px;top:-35px;right:5%;opacity:.1;filter:invert(100%)}.post-copyright{border-radius:var(--radius);margin:2em 0 0;padding:.5em 1em;border-left:3px solid #ff1700;background-color:var(--code-bg);list-style:none;position:relative;overflow:hidden}.post-copyright li{margin:8px 0}</style></main><footer class=footer><span>&copy; 2023 <a href=https://blog.lvcshu.com/>johnpoint's blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script><script async defer data-website-id=7319ce07-a672-4d99-bf07-9ebb227d449d src=https://umami.uipo.cc/umami.js></script></body></html>